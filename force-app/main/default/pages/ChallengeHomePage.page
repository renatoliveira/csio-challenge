<apex:page showHeader="false" sidebar="false" name="ChallengeHomePage" applyHtmlTag="false" applyBodyTag="false" standardStylesheets="false">
<html>
    <head>
        <title>Salesforce Application Intake - Design &amp; Implementation Exercise</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css"
        />
        <script>
        const FORM_SUBMIT_URL = '/services/apexrest/v1/form/submit';

        function getInputType(field) {
            if (field.type.toLowerCase() === 'money') return 'number';
            if (field.name.toLowerCase() === 'email') return 'email';
            if (field.name.toLowerCase() === 'phone') return 'tel';
            return 'text';
        }

        function showFormMessage(message, isError) {
            var el = document.getElementById('form-message');
            if (!el) return;
            el.textContent = message;
            el.className = 'notification is-light ' + (isError ? 'is-danger' : 'is-success');
            el.style.display = 'block';
        }

        function hideFormMessage() {
            var el = document.getElementById('form-message');
            if (el) el.style.display = 'none';
        }

        function renderForm(template) {
            window.formTemplate = template;
            var form = document.getElementById('application-form');
            form.innerHTML = '';
            var keys = Object.keys(template);
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                var field = template[key];
                if (!field) continue;
                var fieldId = 'field-' + field.name;
                var inputType = getInputType(field);
                var fieldDiv = document.createElement('div');
                fieldDiv.className = 'field';
                fieldDiv.innerHTML =
                    '<label class="label" for="' + fieldId + '">' + (field.label || '') + '</label>' +
                    '<div class="control">' +
                    '<input class="input" type="' + inputType + '" id="' + fieldId + '" name="' + (field.name || '') + '"' +
                    (field.required ? ' required' : '') +
                    (inputType === 'number' ? ' step="0.01"' : '') +
                    ' />' +
                    '</div>';
                form.appendChild(fieldDiv);
            }
            var submitWrap = document.createElement('div');
            submitWrap.className = 'field mt-5';
            submitWrap.innerHTML = '<div class="control"><button type="button" class="button is-primary is-fullwidth" onclick="formatAndSubmitForm();">Submit application</button></div>';
            form.appendChild(submitWrap);
        }

        function getFormTemplate() {
            fetch(FORM_SUBMIT_URL, {
                method: 'GET',
                credentials: 'same-origin'
            }).then(function(response) {
                if (!response.ok) {
                    showFormMessage('Failed to load form template.', true);
                    return;
                }
                return response.json();
            }).then(function(data) {
                if (data) {
                    hideFormMessage();
                    renderForm(data);
                }
            }).catch(function() {
                showFormMessage('Failed to load form template.', true);
            });
        }

        function formatAndSubmitForm() {
            var template = window.formTemplate;
            if (!template) {
                showFormMessage('Form template not loaded.', true);
                return;
            }
            var form = document.getElementById('application-form');
            var payload = {};
            var keys = Object.keys(template);
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                var field = template[key];
                if (!field) continue;
                var input = form.elements.namedItem(field.name);
                var value = input ? input.value : null;
                if (value !== null && value !== undefined) value = String(value).trim();
                payload[key] = {
                    label: field.label,
                    name: field.name,
                    required: field.required,
                    type: field.type,
                    value: value || null
                };
            }
            hideFormMessage();
            fetch(FORM_SUBMIT_URL, {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(function(response) {
                return response.text().then(function(text) {
                    var body = null;
                    try { body = text ? JSON.parse(text) : null; } catch (e) {}
                    return { status: response.status, body: body };
                });
            }).then(function(result) {
                var msg = result.body && result.body.message ? result.body.message : (result.status === 200 ? 'Form submitted successfully' : 'Form submitted failed');
                showFormMessage(msg, result.status !== 200);
            }).catch(function() {
                showFormMessage('Failed to submit form.', true);
            });
        }

        getFormTemplate();
        </script>
    </head>
    <body class="has-background-light">
        <section class="section">
            <div class="container" style="max-width: 640px;">
                <h1 class="title is-3 has-text-centered mb-5">Application Intake</h1>
                <p class="subtitle is-6 has-text-centered has-text-grey mb-5">Design &amp; Implementation Exercise</p>

                <div class="box">
                    <div id="form-message" class="notification is-light" style="display: none;"></div>
                    <form id="application-form">
                    </form>
                </div>
            </div>
        </section>
    </body>
</html>
</apex:page>